import{f4 as Ie,dq as xe,dr as Ee,f6 as _e,a6 as V,cm as be,s as Z,cK as Se,fz as Ae,ab as E,fA as W,eU as U,A as q,cc as he,bf as Re,z as de,bN as Le,fB as ze,ds as Ge,a0 as b,a1 as w,fe as Pe,a2 as Fe}from"./index-jfgqsXUF.js";import{S as J,E as $e,D as Be,C as Oe,o as Ue,g as je,a as Qe,b as We,c as qe,_ as He,P as Ve,A as Je,v as Ke,d as z,e as Xe,f as ee,u as we,i as Me}from"./KnowledgeGraphSublayer-DXUl9nCj.js";import{s as H}from"./featureConversionUtils-BAN7iPzO.js";import{_ as M,I as te,t as ae,S as N,o as Ye}from"./constants-B4mRqufT.js";import{I as Ze}from"./knowledgeGraphService-alm_NYnC.js";import"./vendor-0HVaVRtn.js";import"./OptimizedGeometry-aBFBEGLw.js";import"./memoryEstimations-BucWCUN2.js";import"./OptimizedFeature-CQnDPIV2.js";import"./GraphicsLayer-dBDZScBF.js";import"./Relationship-B1ouIAl4.js";import"./FeatureStore-xM2hGjLr.js";import"./BoundsStore-DLe4Gen1.js";import"./PooledRBush-DYGfsruq.js";import"./timeSupport-CbVV7g16.js";import"./queryUtils-BqV_MD1M.js";import"./json-Wa8cmqdu.js";import"./optimizedFeatureQueryEngineAdapter-LmXD017v.js";import"./QueryEngine-BAWh_FLQ.js";import"./WhereClauseCache-CCYkt0B3.js";import"./WhereClause-mqdqH7zu.js";import"./TimeOnly-C39e4_MX.js";import"./QueryEngineCapabilities-B_pTbIiR.js";import"./quantizationUtils-Cx9cQSOo.js";import"./utils-BuigcV0U.js";import"./utils-D6Su7kzx.js";import"./ClassBreaksDefinition-1D8MEf8v.js";import"./SnappingCandidate-DGkpYqI6.js";import"./FixedIntervalBinParameters-4n3tUwwc.js";import"./clientSideDefaults-uEFw8Ic2.js";import"./OptimizedFeatureSet-Blu9Ckm7.js";import"./networkEnums-FLEDwOgG.js";import"./GPMessage-UXsVnLDz.js";var K;(function(e){e.MULTIPLIER="multiplier",e.ABSOLUTE="absolute-value"})(K||(K={}));let m=class extends Ie(xe(Ee(_e(Ge)))){constructor(e){if(super(e),this.url=null,this.dataPreloadedInLocalCache=!1,this.initializationLinkChartConfig=null,this.membershipModified=!0,this._currentLinkChartConfig={layoutMode:"organic-standard"},this._graphTypeLookup=new Map,this.dataManager=null,this.knowledgeGraph=null,this.layers=new(V.ofType(J)),this.entityLinkChartDiagramLookup=new Map,this.relationshipLinkChartDiagramLookup=new Map,this.linkChartExtent=new be({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7}),this.memberEntityTypes=null,this.memberRelationshipTypes=null,this.operationalLayerType="LinkChartLayer",this.sublayerIdsCache=new Map,this.tables=new(V.ofType(J)),this.type="link-chart",this.chronologicalAuxiliaryGraphics=null,this._originalInclusionList=e?.initializationInclusionModeDefinition,e?.dataPreloadedInLocalCache&&!e?.initializationInclusionModeDefinition)throw new Z("knowledge-graph:linkchart-layer-constructor","If creating a link chart composite layer and configured that data is already loaded in the cache, you must specify an inclusion list so the Composite Layer knows what records belong to it");this.addHandles(Se(()=>this.layers.concat(this.tables),(a,i)=>this._handleSublayersChange(a,i),Ae))}normalizeCtorArgs(e){if(!e)return{};const{url:a,title:i,dataPreloadedInLocalCache:n,initializationLinkChartConfig:t}=e;return{url:a,title:i,dataPreloadedInLocalCache:n,initializationLinkChartConfig:t}}_initializeLayerProperties(e){if(!this.title&&this.url){const o=this.url.split("/");this.title=o[o.length-2]}const a=new Set;let i=[],n=[];if(e.inclusionModeDefinition&&(!e.inclusionModeDefinition.namedTypeDefinitions||e.inclusionModeDefinition.namedTypeDefinitions.size<1))throw new Z("knowledge-graph:composite-layer-constructor","If an explicit inclusion definition is defined, at least one namedTypeDefinition must also be defined");e.inclusionModeDefinition?.generateAllSublayers?(i=e.knowledgeGraph.dataModel.entityTypes??[],n=e.knowledgeGraph.dataModel.relationshipTypes??[]):e.inclusionModeDefinition?.namedTypeDefinitions&&e.inclusionModeDefinition?.namedTypeDefinitions.size>0?e.inclusionModeDefinition?.namedTypeDefinitions.forEach((o,r)=>{const y=this._graphTypeLookup.get(r);if(!y)return E.getLogger(this).warn(`A named type, ${r}, was in the inclusion list that wasn't in the data model and will be removed`),void e.inclusionModeDefinition?.namedTypeDefinitions.delete(r);y.type==="relationship"?a.has(r)||(a.add(r),n.push(y)):y.type==="entity"?a.has(r)||(a.add(r),i.push(y)):(E.getLogger(this).warn(`A named type, ${r}, was in the inclusion list that wasn't properly modeled and will be removed`),e.inclusionModeDefinition?.namedTypeDefinitions.delete(r))}):(i=e.knowledgeGraph.dataModel.entityTypes??[],n=e.knowledgeGraph.dataModel.relationshipTypes??[]);const t=new $e({knowledgeGraph:e.knowledgeGraph,inclusionModeDefinition:e.inclusionModeDefinition});this.knowledgeGraph=e.knowledgeGraph,this.memberEntityTypes=i,this.memberRelationshipTypes=n,this.dataManager=t}load(e){const a=async()=>{const i=[],n=[];this.loadLayerAssumingLocalCache(),this._layersLoadedFromAuthoritativeItem()||await Me(this),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach(t=>{t.useAllData=!1}),await this._initializeDiagram(),this.layers.forEach(t=>{n.push(t.refreshCachedQueryEngine()),i.push(new Promise(o=>{t.on("layerview-create",()=>{o(null)})}))}),this.tables.forEach(t=>{n.push(t.refreshCachedQueryEngine())}),await Promise.all(n)};return this.addResolvingPromise(new Promise(i=>{Ze(this.url).then(async n=>{n.dataModel.entityTypes?.forEach(o=>{o.name&&this._graphTypeLookup.set(o.name,o)}),n.dataModel.relationshipTypes?.forEach(o=>{o.name&&this._graphTypeLookup.set(o.name,o)});const t=this.linkChart?.linkChartProperties;if(t?.originIdOf("entitiesUrl")===W.LINK_CHART&&(this.membershipModified=!1,this._originalInclusionList=await Be.fetchAndConvertSerializedLinkChart({entitiesUrl:t?.entitiesUrl,relationshipsUrl:t?.relationshipsUrl}),this._alignLayersDataModelAndInclusionDefinition(n.dataModel),this.initializationLinkChartConfig={layoutSettings:t?.layoutSettings??void 0,layoutMode:Oe(t.layoutType)}),this._initializeLayerProperties({knowledgeGraph:n,inclusionModeDefinition:this._originalInclusionList}),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.size||(this.dataManager.inclusionModeDefinition={generateAllSublayers:!1,namedTypeDefinitions:new Map},this.dataManager.knowledgeGraph.dataModel.entityTypes?.forEach(o=>{o.name&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(o.name,{useAllData:!0})}),this.dataManager.knowledgeGraph.dataModel.relationshipTypes?.forEach(o=>{o.name&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(o.name,{useAllData:!0})})),this.dataPreloadedInLocalCache){const o=Ue.getInstance();for(const[r,y]of this.dataManager.inclusionModeDefinition?.namedTypeDefinitions??[])for(const u of y.members?.values()??[]){const g=o.readFromStoreById(`${r}__${u.id}`);g&&U(this.dataManager.sublayerCaches,r,()=>new Map).set(u.id,g)}await a()}else{const o=this.initializationLinkChartConfig?.layoutMode==="geographic-organic-standard";this.addResolvingPromise(this.dataManager.refreshCacheContent(void 0,!1,o,!0).then(async()=>{q(e),await a()}))}i(null)})})),Promise.resolve(this)}set initializationInclusionModeDefinition(e){this.loadStatus!=="loaded"&&this.loadStatus!=="failed"?this._set("initializationInclusionModeDefinition",e):E.getLogger(this).error("#initializationInclusionModeDefinition","initializationInclusionModeDefinition cannot be changed after the layer is loaded.")}get linkChart(){return this.parent}async addRecords(e,a){let i=[];a?.cascadeAddRelationshipEndNodes&&this.dataManager.knowledgeGraph.dataModel&&(i=await je(e,this.dataManager.knowledgeGraph));const n=e.concat(i).filter(t=>!this.sublayerIdsCache.get(t.typeName)?.has(t.id));n.length>0&&(this.membershipModified=!0),await this._handleNewRecords(n,a)}async removeRecords(e,{cascadeRemoveRelationships:a=!0,recalculateLayout:i=!1,overrideMembershipCheck:n=!1}={cascadeRemoveRelationships:!0,recalculateLayout:!1,overrideMembershipCheck:!1}){let t=[];for(const r of e)(n||this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(r.typeName)?.useAllData===!1&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(r.typeName)?.members?.has(r.id))&&t.push(r);if(a){const r=new Set,y=[];for(const u of t)if(this.dataManager.nodeConnectionsLookup.has(u.id))for(const g of this.dataManager.nodeConnectionsLookup.get(u.id))r.add(g);for(const u of r)if(this.dataManager.memberIdTypeLookup.has(u))for(const g of this.dataManager.memberIdTypeLookup.get(u))this.dataManager.relationshipTypeNames.has(g)&&y.push({id:u,typeName:g});t=t.concat(y)}this.dataManager.removeFromLayer(t);for(const r of t)this.sublayerIdsCache.get(r.typeName)?.delete(r.id),this.dataManager.relationshipTypeNames.has(r.typeName)?this.relationshipLinkChartDiagramLookup.delete(r.id):this.entityLinkChartDiagramLookup.delete(r.id);i&&await this._calculateLayoutWithSublayerTimeInfo(this._currentLinkChartConfig.layoutMode,{layoutSettings:this._currentLinkChartConfig.layoutSettings}),t.length>0&&(this.membershipModified=!0);const o=[];return this.layers.forEach(r=>{o.push(r.refreshCachedQueryEngine())}),await Promise.all(o),this._refreshNamedTypes(),t}async expand(e,a){let i=[];try{const n=await this.dataManager.getConnectedRecordIds(e,a?.relationshipTypeNames,a);i=n.filter(t=>!this.sublayerIdsCache.get(t.typeName)?.has(t.id)),await this._handleNewRecords(n,a),n.length>0&&(this.membershipModified=!0),q(a?.signal)}catch(n){throw he(n)&&i.length>0&&this.removeRecords(i,{overrideMembershipCheck:!0}),n}return{records:i}}loadLayerAssumingLocalCache(){const e=[...this.memberRelationshipTypes,...this.memberEntityTypes];this.originIdOf("layers")===W.DEFAULTS?this._createSublayers(e,this.layers,a=>!!a.geometryType):this._updateSublayers(e,this.layers),this.originIdOf("tables")===W.DEFAULTS?this._createSublayers(e,this.tables,a=>!a.geometryType):this._updateSublayers(e,this.tables),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach((a,i)=>{const n=U(this.sublayerIdsCache,i,()=>new Set);a.members?.forEach(({id:t,linkChartLocation:o})=>{if(n.add(t),o){const r="coords"in o&&"lengths"in o?o:H(o);this.dataManager.relationshipTypeNames.has(i)?this.relationshipLinkChartDiagramLookup.set(t,r):this.entityLinkChartDiagramLookup.set(t,r)}})})}async calculateLinkChartLayout(e="organic-standard",a){const i=[],n=[],t=[];this.dataManager.sublayerCaches.forEach((s,h)=>{this.dataManager.entityTypeNames.has(h)?s.forEach(l=>{i.push({typeName:h,feature:l})}):this.dataManager.relationshipTypeNames.has(h)&&s.forEach(l=>{n.push({typeName:h,feature:l})})}),this.entityLinkChartDiagramLookup=new Map,this.relationshipLinkChartDiagramLookup=new Map;const o=new Map,r=new Map,y=new Map,u=new Map,g=new Uint8Array(i.length),L=new Float64Array(i.length),f=new Float64Array(i.length),O=new Float64Array(i.length),S=new Float64Array(i.length),k=new Uint32Array(n.length),ie=new Uint32Array(n.length),ue=new Float64Array(n.length),pe=new Float64Array(n.length),c=[],ke="organic-standard",x=new be({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7});let F,ce="organic-standard",p=0,v=0;const Ce=Qe.apply;switch(ce=e==="geographic-organic-standard"?ke:e,ce){case"organic-standard":F=Ke.apply;break;case"organic-community":F=Je.apply;break;case"hierarchical-bottom-to-top":F=Ve.apply;break;case"radial-root-centric":F=He.apply;break;case"tree-left-to-right":F=qe.apply;break;default:F=We.apply}let ne=!1;i.forEach(({typeName:s,feature:h})=>{if(e!=="chronological-mono-timeline"&&e!=="chronological-multi-timeline"&&a?.lockedNodeLocations?.has(h.attributes[M])){e==="geographic-organic-standard"&&this.dataManager.geographicLookup.has(s)?g[p]=z.IsGeographic:g[p]=z.None;const l=a.lockedNodeLocations.get(h.attributes[M]);L[p]=l.x,f[p]=l.y}else if(e==="geographic-organic-standard"&&this.dataManager.geographicLookup.has(s)){g[p]=z.IsGeographic;let l=null;const C=h.attributes[this.dataManager.geographicLookup.get(s).name];switch(this.dataManager.geographicLookup.get(s)?.geometryType){case"esriGeometryPoint":L[p]=C?.x,f[p]=C?.y;break;case"esriGeometryPolygon":l=C?.centroid,l?.x!=null&&l?.y!=null?(L[p]=l.x,f[p]=l.y):g[p]=z.IsMovable;break;case"esriGeometryPolyline":case"esriGeometryMultipoint":l=C?.extent?.center,l?.x!=null&&l?.y!=null?(L[p]=l.x,f[p]=l.y):g[p]=z.IsMovable;break;default:g[p]=z.IsMovable}(L[p]==null||f[p]==null||Number.isNaN(L[p])||Number.isNaN(f[p]))&&(g[p]=z.IsMovable,L[p]=0,f[p]=0)}else if(e==="chronological-mono-timeline"||e==="chronological-multi-timeline"){!ne&&a?.lockedNodeLocations?.has(h.attributes[M])&&(ne=!0);const l=a?.timeInfoByTypeName?.get(s),C=l?.startField,A=C&&l?.startField?h.attributes[C]:null;O[p]=A?new Date(A).getTime():NaN;const T=l?.endField,I=T&&l?.endField?h.attributes[T]:null;S[p]=I?new Date(I).getTime():NaN,L[p]=0,f[p]=0,g[p]=z.IsMovable}else g[p]=z.IsMovable,L[p]=0,f[p]=0;u.set(h.attributes[M],p),c[p]={feature:h,typeName:s},p++}),ne&&E.getLogger(this).warn("Locked node locations are not supported for chronological layout at this time.  Requested node locations were ignored");let ye=!1;const oe=new Map;n.forEach(s=>{const h=s.feature.attributes[te],l=s.feature.attributes[ae],C=u.get(h),A=u.get(l),T=a?.timeInfoByTypeName?.get(s.typeName),I=a?.timeInfoByTypeName?T?.startField:null,R=I?s.feature.attributes[I]:null,Y=T?.endField,$=Y?s.feature.attributes[Y]:null;if(C!==void 0&&A!==void 0){let G=h+"-"+l;e!=="chronological-mono-timeline"&&e!=="chronological-multi-timeline"||(G=G+"-"+R+"-"+$);const Q=oe.get(G);Q?.has(s.typeName)||(k[v]=C,ie[v]=A,e!=="chronological-mono-timeline"&&e!=="chronological-multi-timeline"||(ue[v]=R?new Date(R).getTime():NaN,pe[v]=$?new Date($).getTime():NaN),Q===void 0?oe.set(G,new Map([[s.typeName,v]])):Q.set(s.typeName,v),v++),t.push(s)}else ye=!0,this.relationshipLinkChartDiagramLookup.set(h,null)}),ye&&E.getLogger(this).warn("A relationship is a member of this layer that has either origin or destination entity nodes that are not members. The diagram geometry will be set to null");const Te=this._validateOrganicLayoutSettings(e,a?.layoutSettings?.organicLayoutSettings),se=this._convertValidatedOrganicSettingsToCalculationSettings(Te);await Xe();let j=ee.Error,D=null;if(e==="chronological-mono-timeline"||e==="chronological-multi-timeline"){let s;({status:j,links:D,graphics:s}=Ce(()=>a?.signal?.aborted??!1,g,L,f,O,S,k.subarray(0,v),ie.subarray(0,v),ue.subarray(0,v),pe.subarray(0,v),e==="chronological-multi-timeline",a?.layoutSettings?.chronologicalLayoutSettings)),j===ee.Success&&(this.chronologicalAuxiliaryGraphics=s)}else({status:j,links:D}=F(()=>a?.signal?.aborted??!1,g,L,f,k.subarray(0,v),ie.subarray(0,v),se.computationBudgetTime,se.idealEdgeLengthMultiplier,se.repulsionRadiusMultiplier));if(q(a?.signal),j===ee.Error)throw new Z("knowledge-graph:layout-failed","Attempting to arrange the records in the specified layout failed");if(j===ee.Canceled)throw Re();for(let s=0;s<c.length;s++){if(f[s]>84.9999?f[s]=84.9999:f[s]<-84.9999&&(f[s]=-84.9999),L[s]>179.9999?L[s]=179.9999:L[s]<-179.9999&&(L[s]=-179.9999),c[s].feature.attributes[N]=new de(L[s],f[s]),o.has(c[s].typeName))o.get(c[s].typeName)?.set(c[s].feature.attributes[M],c[s].feature);else{const C=new Map;C.set(c[s].feature.attributes[M],c[s].feature),o.set(c[s].typeName,C)}y.set(c[s].feature.attributes[M],c[s].feature);const h=H(c[s].feature.attributes[N]);this.entityLinkChartDiagramLookup.set(c[s].feature.attributes[M],c[s].feature.attributes[N]?h:null);const l=U(this.dataManager.inclusionModeDefinition.namedTypeDefinitions,c[s].typeName,()=>({useAllData:!1,members:new Map}));U(l.members,c[s].feature.attributes[M],()=>({id:c[s].feature.attributes[M],linkChartLocation:void 0})).linkChartLocation=c[s].feature.attributes[N],c[s].feature.attributes[N].x<x.xmin&&(x.xmin=c[s].feature.attributes[N].x),c[s].feature.attributes[N].x>x.xmax&&(x.xmax=c[s].feature.attributes[N].x),c[s].feature.attributes[N].y<x.ymin&&(x.ymin=c[s].feature.attributes[N].y),c[s].feature.attributes[N].y>x.ymax&&(x.ymax=c[s].feature.attributes[N].y)}if(this.linkChartExtent.xmin=x.xmin,this.linkChartExtent.xmax=x.xmax,this.linkChartExtent.ymin=x.ymin,this.linkChartExtent.ymax=x.ymax,!D)throw new Z("knowledge-graph:layout-failed","Attempting to retrieve link geometry from diagram engine failed");const X=new Map,re=new Map,le=new Map,ge=new Set;for(let s=0;s<t.length;s++){const h=[],l=t[s],C=l.feature.attributes[te],A=l.feature.attributes[ae];let T=C+"-"+A;if(e==="chronological-mono-timeline"||e==="chronological-multi-timeline"){const d=a?.timeInfoByTypeName?.get(l.typeName),_=a?.timeInfoByTypeName?d?.startField:null,P=_?l.feature.attributes[_]:null,B=d?.endField;T+="-"+P+"-"+(B?l.feature.attributes[B]:null)}const I=oe.get(T).get(l.typeName),R=I===0?0:D?.vertexEndIndex[I-1];if(!ge.has(I)){if(ge.add(I),D.types[I]===we.Recursive){const d=[D.vertices[2*R],D.vertices[2*R+1]],_=[D.vertices[2*(R+1)],D.vertices[2*(R+1)+1]],P=[.5*(d[0]+_[0]),.5*(d[1]+_[1])],B=[P[0]-d[0],P[1]-d[1]],ve=[P[0]+B[1],P[1]-B[0]],De=[P[0]-B[1],P[1]+B[0]];h.push(d),h.push(ve),h.push(_),h.push(De),h.push(d)}else{if(D.types[I]!==we.Regular){E.getLogger(this).warn("A relationship generated an unsupported link geometry type.  It will not be rendered");continue}for(let d=R;d<D.vertexEndIndex[I];d++)h.push([D.vertices[2*d],D.vertices[2*d+1]])}if(e!=="chronological-mono-timeline"&&e!=="chronological-multi-timeline"){const d=c[u.get(C)]?.feature.attributes[N],_=c[u.get(A)]?.feature.attributes[N];h[0][0]===d.x&&h[0][1]===d.y||(h[0]=[d.x,d.y]),h[h.length-1][0]===_.x&&h[h.length-1][1]===_.y||(h[h.length-1]=[_.x,_.y])}for(let d=1;d<h.length-1;d++)h[d][1]>85.5?h[d][1]=85.5:h[d][1]<-85.5&&(h[d][1]=-85.5),h[d][0]>179.9999?h[d][0]=179.9999:h[d][0]<-179.9999&&(h[d][0]=-179.9999);X.has(T)?X.get(T).push(h):X.set(T,[h])}const Y=X.get(T);re.has(T)||(re.set(T,new Map),le.set(T,new Map));const $=re.get(T),G=le.get(T);$.has(l.typeName)||($.set(l.typeName,Y.shift()),G.set(l.typeName,0));const Q=$.get(l.typeName);G.set(l.typeName,G.get(l.typeName)+1);const me=new Le({paths:[Q]});if(l.feature.attributes[N]=me,r.has(l.typeName))r.get(l.typeName)?.set(l.feature.attributes[M],l.feature);else{const d=new Map;d.set(l.feature.attributes[M],l.feature),r.set(l.typeName,d)}y.set(l.feature.attributes[M],l.feature);const fe=H(l.feature.attributes[N]);this.relationshipLinkChartDiagramLookup.set(l.feature.attributes[M],l.feature.attributes[N]?fe:null);const Ne=U(this.dataManager.inclusionModeDefinition.namedTypeDefinitions,l.typeName,()=>({useAllData:!1,members:new Map}));U(Ne.members,l.feature.attributes[M],()=>({id:l.feature.attributes[M],linkChartLocation:void 0})).linkChartLocation=fe}for(const s of t)s.feature.attributes[Ye]=le.get(s.feature.attributes[te]+"-"+s.feature.attributes[ae])?.get(s.typeName)??null;return this._currentLinkChartConfig={layoutMode:e,layoutSettings:a?.layoutSettings?.clone()},{nodes:o,links:r,idMap:y}}async applyNewLinkChartLayout(e="organic-standard",a){const i=[];await this._calculateLayoutWithSublayerTimeInfo(e,a),this.layers.forEach(n=>{i.push(n.refreshCachedQueryEngine())}),this.membershipModified=!0,await Promise.all(i),this._refreshNamedTypes()}getCurrentNodeLocations(){const e=new Map;for(const[a,i]of this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.entries()??[])this.dataManager.relationshipTypeNames.has(a)||i?.members?.forEach(n=>{const t=n.linkChartLocation;let o;const r=n.id;t&&(o="x"in t?{x:t.x,y:t.y}:{x:t.coords[0],y:t.coords[1]},e.set(r,new de({x:o.x,y:o.y})))});return e}async refreshLinkChartCache(e){await this.dataManager.refreshCacheContent(e);const a=[];this.layers.forEach(i=>{a.push(i.refreshCachedQueryEngine())}),await Promise.all(a),this._refreshNamedTypes()}async connectBetweenEntities(e,a){if(!e.length)return{records:[]};let i=[];try{let n=[];for(const t of this.dataManager.relationshipTypeNames){const o=this.sublayerIdsCache.get(t);o&&(n=n.concat(Array.from(o.keys())))}i=await this.dataManager.getRelationshipsBetweenNodes(e,n,a),await this._handleNewRecords(i,a),q(a)}catch(n){throw he(n)&&this.removeRecords(i),n}return{records:i}}async connectFromEntities(e,a){if(!e.length)return{records:[]};let i=[];try{let n=[];for(const o of this.dataManager.relationshipTypeNames){const r=this.sublayerIdsCache.get(o);r&&(n=n.concat(Array.from(r.keys())))}let t=[];for(const o of this.dataManager.entityTypeNames){const r=this.sublayerIdsCache.get(o);r&&(t=t.concat(Array.from(r)))}i=await this.dataManager.getRelationshipsFromNodes(e,t,n,a),await this._handleNewRecords(i,a),i.length>0&&(this.membershipModified=!0),q(a)}catch(n){throw he(n)&&this.removeRecords(i),n}return{records:i}}getCurrentLayout(){return this._currentLinkChartConfig.layoutMode}async _calculateLayoutWithSublayerTimeInfo(e="organic-standard",a){const i=new Map;this.layers.forEach(n=>{i.set(n.objectType.name,n.timeInfo)}),await this.calculateLinkChartLayout(e,{timeInfoByTypeName:i,...a}),this.linkChart?.handleChronologicalOverlay()}async _handleNewRecords(e,a){const i=[];this.dataManager.addToLayer(e);for(const t of e)this.sublayerIdsCache.has(t.typeName)||(this.sublayerIdsCache.set(t.typeName,new Set),i.push(t.typeName)),this.sublayerIdsCache.get(t.typeName).add(t.id);for(const t of i){const o=this._graphTypeLookup.get(t);if(o){const r=this._createSublayer(o);o.type==="entity"?this.dataManager.entityTypeNames.add(t):this.dataManager.relationshipTypeNames.add(t),r.geometryType?this.layers.push(r):this.tables.push(r),this.dataManager.sublayerCaches.set(t,new Map)}}await Me(this,i,a),await this.dataManager.refreshCacheContent(e.map(t=>t.id),void 0,void 0,void 0,a);const n={layoutSettings:this._currentLinkChartConfig.layoutSettings,lockedNodeLocations:new Map};for(const[t,o]of this.entityLinkChartDiagramLookup.entries())o&&n.lockedNodeLocations.set(t,new de(o.coords[0],o.coords[1]));await this.applyNewLinkChartLayout(this._currentLinkChartConfig.layoutMode,n)}_createSublayers(e,a,i){e.forEach(n=>{const t=this._createSublayer(n);i(t)&&a.push(t),this._updateSublayerCaches(n)})}_updateSublayers(e,a){a.forEach(i=>{i.parentCompositeLayer=this;const n=e.find(t=>t.type===i.graphType&&t.name===i.graphTypeName);n&&(i.objectType=n,i.read({title:n.name},{origin:"service"}),this._updateSublayerCaches(n))})}_updateSublayerCaches(e){const a=this.dataManager.sublayerCaches;a.has(e.name)||a.set(e.name,new Map)}_layersLoadedFromAuthoritativeItem(){const e=this.originIdOf("layers");return e>=W.PORTAL_ITEM&&e<W.USER}async _initializeDiagram(){this.initializationLinkChartConfig?this.initializationLinkChartConfig.doNotRecalculateLayout?(this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach((e,a)=>{e?.members?.forEach(i=>{const n=i.linkChartLocation;let t;const o=i.id;if(!n)return;t="x"in n?{x:n.x,y:n.y}:{x:n.coords[0],y:n.coords[1]};const r=H(t);this.dataManager.relationshipTypeNames.has(a)?this.relationshipLinkChartDiagramLookup.set(o,r):this.entityLinkChartDiagramLookup.set(o,r),this.linkChartExtent.xmin>t.x&&(this.linkChartExtent.xmin=t.x),this.linkChartExtent.xmax<t.x&&(this.linkChartExtent.xmax=t.x),this.linkChartExtent.ymin>t.y&&(this.linkChartExtent.ymin=t.y),this.linkChartExtent.ymax<t.y&&(this.linkChartExtent.ymax=t.y)})}),this.memberRelationshipTypes.forEach(e=>{e.name&&this.dataManager.sublayerCaches.get(e.name)?.forEach(a=>{const i=this.relationshipLinkChartDiagramLookup.get(a.attributes[te]),n=this.relationshipLinkChartDiagramLookup.get(a.attributes[ae]);if(i&&n){const t=H(new Le({paths:[[[i.coords[0],i.coords[1]],[n.coords[0],n.coords[1]]]]}));this.relationshipLinkChartDiagramLookup.set(a.attributes[M],t)}else this.relationshipLinkChartDiagramLookup.set(a.attributes[M],null)})})):await this._calculateLayoutWithSublayerTimeInfo(this.initializationLinkChartConfig.layoutMode,{lockedNodeLocations:this.getCurrentNodeLocations(),...this.initializationLinkChartConfig||{}}):await this._calculateLayoutWithSublayerTimeInfo("organic-standard",{lockedNodeLocations:this.getCurrentNodeLocations()})}_refreshNamedTypes(){for(const e of this.layers)e.emit("refresh",{dataChanged:!0});for(const e of this.tables)e.emit("refresh",{dataChanged:!0})}_validateOrganicLayoutSettings(e,a){const i=k=>typeof k=="number"&&!isNaN(k),n=k=>i(k)&&k>=1,t=k=>i(k)&&k>=1,o=k=>Object.values(K).includes(k),r=k=>i(k)&&k>=0,y={};if(!new Set(["organic-standard","organic-community","geographic-organic-standard","chronological-multi-timeline","chronological-mono-timeline"]).has(e)||!a)return y;const{computationBudgetTime:u,autoRepulsionRadius:g,repulsionRadiusMultiplier:L,absoluteIdealEdgeLength:f,multiplicativeIdealEdgeLength:O,idealEdgeLengthType:S}=a;return t(u)?y.computationBudgetTime=u:u&&E.getLogger(this).warn("Invalid layout computationBudgetTime setting, will revert to default setting"),y.autoRepulsionRadius=g,!g&&n(L)?y.repulsionRadiusMultiplier=L:g||(y.autoRepulsionRadius=!0,E.getLogger(this).warn("Invalid layout repulsionRadiusMultiplier setting, will revert to default setting")),e==="geographic-organic-standard"&&(o(S)?y.idealEdgeLengthType=S:S!==void 0&&E.getLogger(this).warn('Invalid layout idealEdgeLengthType setting, will revert to "multiplier" setting'),S==="absolute-value"&&r(f)?y.absoluteIdealEdgeLength=f:S==="absolute-value"&&f!==void 0?E.getLogger(this).warn("Invalid layout idealEdgeLength setting, will revert to default setting"):S==="multiplier"&&r(O)?y.multiplicativeIdealEdgeLength=O:S==="multiplier"&&O!==void 0&&E.getLogger(this).warn("Invalid layout idealEdgeLength setting, will revert to default setting")),y}_convertValidatedOrganicSettingsToCalculationSettings(e){let a=e.idealEdgeLengthType===K.ABSOLUTE?e.absoluteIdealEdgeLength:e.multiplicativeIdealEdgeLength;return e.idealEdgeLengthType===K.ABSOLUTE&&(a===void 0?a=-1:a*=-1),{computationBudgetTime:e.computationBudgetTime??void 0,repulsionRadiusMultiplier:e.repulsionRadiusMultiplier&&!e.autoRepulsionRadius?e.repulsionRadiusMultiplier:void 0,idealEdgeLengthMultiplier:a}}_createSublayer(e){return new J({objectType:e,parentCompositeLayer:this,graphType:e.type})}_handleSublayersChange(e,a){a&&(a.forEach(i=>{i.parent=null}),this.removeHandles("sublayers-owner")),e&&(e.forEach(i=>{i.parent=this}),this.addHandles([e.on("after-add",({item:i})=>{i.parent=this}),e.on("after-remove",({item:i})=>{i.parent=null})],"sublayers-owner"))}_alignLayersDataModelAndInclusionDefinition(e){const a=new Set((e.entityTypes??[]).map(t=>t.name).concat((e.relationshipTypes??[]).map(t=>t.name))),i=new Set((e.entityTypes??[]).map(t=>t.name)),n=new Set((e.relationshipTypes??[]).map(t=>t.name));if(this.layers){for(const o of this.layers)!o.graphType&&a.has(o.graphTypeName)&&(o.graphType=i.has(o.graphTypeName)?"entity":"relationship");const t=this.layers.filter(o=>a.has(o.graphTypeName)&&(o.graphType==="entity"?i.has(o.graphTypeName):n.has(o.graphTypeName)));this.setAtOrigin("layers",t,ze(this.originIdOf("layers")))}else this.layers=new V;if(this.layers&&this._originalInclusionList){const t=new Set(this._originalInclusionList.namedTypeDefinitions.keys()),o=this.tables?.map(u=>u.graphTypeName)??[],r=this.layers.map(u=>u.graphTypeName).concat(o);for(const u of r)t.has(u)||this._originalInclusionList.namedTypeDefinitions.set(u,{useAllData:!1,members:new Map});const y=[];for(const u of this._originalInclusionList.namedTypeDefinitions.keys())r.includes(u)||(E.getLogger(this).warn(`A named type, ${u}, was in the serialized feature collection but did not have a sublayer config in the item, so will be removed`),y.push(u));for(const u of y)this._originalInclusionList.namedTypeDefinitions.delete(u)}}};b([w(Pe)],m.prototype,"url",void 0),b([w()],m.prototype,"dataPreloadedInLocalCache",void 0),b([w()],m.prototype,"initializationLinkChartConfig",void 0),b([w()],m.prototype,"membershipModified",void 0),b([w()],m.prototype,"dataManager",void 0),b([w()],m.prototype,"initializationInclusionModeDefinition",null),b([w()],m.prototype,"knowledgeGraph",void 0),b([w({type:V.ofType(J),json:{write:{ignoreOrigin:!0}}})],m.prototype,"layers",void 0),b([w({readOnly:!0})],m.prototype,"linkChart",null),b([w()],m.prototype,"entityLinkChartDiagramLookup",void 0),b([w()],m.prototype,"relationshipLinkChartDiagramLookup",void 0),b([w()],m.prototype,"linkChartExtent",void 0),b([w()],m.prototype,"memberEntityTypes",void 0),b([w()],m.prototype,"memberRelationshipTypes",void 0),b([w({type:["LinkChartLayer"]})],m.prototype,"operationalLayerType",void 0),b([w()],m.prototype,"sublayerIdsCache",void 0),b([w({type:V.ofType(J),json:{write:{ignoreOrigin:!0}}})],m.prototype,"tables",void 0),b([w({json:{read:!1}})],m.prototype,"type",void 0),b([w({json:{read:!1}})],m.prototype,"chronologicalAuxiliaryGraphics",void 0),m=b([Fe("esri.layers.LinkChartLayer")],m);const At=m;export{At as default};
