import{dJ as j,dx as p,dK as m,dG as R,dy as S}from"./index-B9tlkxep.js";import{a as b}from"./CIMSymbolHelper-CDczdLfR.js";import{CIMSymbolRasterizer as V}from"./CIMSymbolRasterizer-XYHKHB7D.js";import{y as $}from"./OverrideHelper-DH6GBC0O.js";import"./vendor-0HVaVRtn.js";import"./BidiEngine-QXap_35O.js";import"./fontUtils-DsoDj4yA.js";import"./OptimizedGeometry-3yaiiwEe.js";import"./memoryEstimations-CfiaYUy-.js";import"./GeometryUtils-wBrWLgdD.js";import"./rasterizingUtils-BaUVAnjr.js";import"./floatRGBA-C-404vFF.js";import"./Rect-CUzevAry.js";import"./BoundingBox-BqeSZFPv.js";import"./CIMResourceManager-DEeAENpj.js";import"./quantizationUtils-T7qneWuZ.js";const d=new V(null),u=m(S.size),P=m(S.maxSize),M=m(S.lineWidth),q=1;async function D(n,e,s){const i=e?.size;let t=i!=null&&typeof i=="object"&&"width"in i?i.width:i,a=i!=null&&typeof i=="object"&&"height"in i?i.height:i;if(t==null||a==null)if(s==="esriGeometryPolygon")t=a=e.maxSize?Math.min(e.maxSize,u):u;else{const o=await E(n,e,s);o&&(t=o.width,a=o.height),s==="esriGeometryPolyline"&&(t=e.maxSize?Math.min(e.maxSize,M):M),t=t!=null&&isFinite(t)?Math.min(t,P):u,a=a!=null&&isFinite(a)?Math.max(Math.min(a,P),q):u}return e.style==="legend"&&s==="esriGeometryPolyline"&&(t=M),{width:t,height:a}}async function E(n,e,s){const{feature:i,fieldMap:t,viewParams:a}=e.cimOptions||e,o=await $.resolveSymbolOverrides(n.data,i,null,t,s,null,a);if(!o)return null;(n=n.clone()).data={type:"CIMSymbolReference",symbol:o},n.data.primitiveOverrides=void 0;const l=[];return b.fetchResources(o,d.resourceManager,l),b.fetchFonts(o,d.resourceManager,l),l.length>0&&await Promise.all(l),b.getEnvelope(o,null,d.resourceManager)}async function te(n,e={}){const{node:s,opacity:i,symbolConfig:t}=e,a=t!=null&&typeof t=="object"&&"isSquareFill"in t&&t.isSquareFill,o=e.cimOptions||e,l=o.geometryType||j(n?.data?.symbol),r=await D(n,e,l),{feature:C,fieldMap:G}=o,I=e?.geometry||a||l!=="esriGeometryPolygon"?"preview":"legend";let v=r;const x=r;if(e?.geometry&&(l==="esriGeometryPolygon"||l==="esriGeometryPolyline")&&(p(r.width)<200||p(r.height)<200)){const O=r.width>r.height?m(200)*r.height/r.width:m(200);v={width:r.width>r.height?m(200):m(200)*r.width/r.height,height:O}}const f=await d.rasterizeCIMSymbolAsync(n,C,v,I,G,l,null,o.viewParams,o.allowScalingUp,e?.geometry?.toJSON());if(!f)return null;const{width:L,height:F}=f,c=document.createElement("canvas");c.width=L,c.height=F,c.getContext("2d").putImageData(f,0,0);const g=p(x.width),w=p(x.height),h=new Image(g,w);h.src=c.toDataURL(),h.ariaLabel=e.ariaLabel??null,h.alt=e.ariaLabel??"",i!=null&&(h.style.opacity=`${i}`);let y=h;if(e.effectView!=null){const z={shape:{type:"image",x:0,y:0,width:g,height:w,src:h.src},fill:null,stroke:null,offset:[0,0]};y=R([[z]],[g,w],{effectView:e.effectView,ariaLabel:e.ariaLabel})}return s&&y&&s.appendChild(y),y}export{te as previewCIMSymbol};
